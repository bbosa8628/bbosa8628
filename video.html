<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat</title>
    <style>
        video { width: 50%; height: auto; }
        #callDialog, #pairStatus { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; }
        .dialogButtons { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Random Video Chat</h1>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="startButton">Start Chat</button>
    <button id="endButton" disabled>End Chat</button>
    <input type="text" id="userId" readonly placeholder="Your ID will appear here" />
    <input type="text" id="callInput" placeholder="Enter friend's ID to call" />
    <button id="callFriend">Call Friend</button>

    <div id="callDialog">
        <p>Incoming call from <span id="callerId"></span></p>
        <div class="dialogButtons">
            <button id="acceptCall">Accept</button>
            <button id="rejectCall">Reject</button>
        </div>
    </div>

    <div id="pairStatus">
        <p id="pairStatusText"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-database.js"></script>
    <script>
        // Initialize Firebase
        var firebaseConfig = {
          apiKey: "AIzaSyBtDcXb6HczI8EQB96sv1fNwSsD0jPhCfQ",
          authDomain: "bbosa8628-97bff.firebaseapp.com",
          databaseURL: "https://bbosa8628-97bff-default-rtdb.firebaseio.com",
          projectId: "bbosa8628-97bff",
          storageBucket: "bbosa8628-97bff.firebasestorage.app",
          messagingSenderId: "662460566939",
          appId: "1:662460566939:web:5c485818c59b212a56e53e",
          measurementId: "G-D9B4Q57DH2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ],
        };

        const pc = new RTCPeerConnection(servers);

        let localStream;
        let remoteStream;
        let localUserId = null;
        let currentRoomId = null;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startButton = document.getElementById('startButton');
        const endButton = document.getElementById('endButton');
        const callFriend = document.getElementById('callFriend');
        const userIdInput = document.getElementById('userId');
        const callInput = document.getElementById('callInput');
        const callDialog = document.getElementById('callDialog');
        const callerId = document.getElementById('callerId');
        const acceptCall = document.getElementById('acceptCall');
        const rejectCall = document.getElementById('rejectCall');
        const pairStatus = document.getElementById('pairStatus');
        const pairStatusText = document.getElementById('pairStatusText');

        startButton.onclick = async () => {
            startButton.disabled = true;
            endButton.disabled = false;
            
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            // Generate a unique ID for the user
            localUserId = Math.random().toString(36).substr(2, 10);
            userIdInput.value = localUserId;

            // Listen for incoming calls
            db.ref('calls').orderByChild('to').equalTo(localUserId).on('child_added', (snapshot) => {
                const call = snapshot.val();
                showCallDialog(call.from);
                snapshot.ref.remove(); // Clean up after showing the dialog
            });
        };

        callFriend.onclick = async () => {
            const friendId = callInput.value;
            if (friendId) {
                const roomRef = db.ref('rooms').push({
                    hasUser: true,
                    offerCandidates: [],
                    answerCandidates: [],
                    from: localUserId,
                    to: friendId,
                    isPaired: false
                });
                currentRoomId = roomRef.key;
                createOffer(roomRef, friendId);
            }
        };

        endButton.onclick = async () => {
            endButton.disabled = true;
            startButton.disabled = false;
            localStream.getTracks().forEach(track => track.stop());
            if (remoteStream) remoteStream.getTracks().forEach(track => track.stop());
            pc.close();
            if (currentRoomId) {
                await db.ref('rooms/' + currentRoomId).remove();
                currentRoomId = null;
            }
        };

        function showCallDialog(caller) {
            callDialog.style.display = 'block';
            callerId.textContent = caller;
            acceptCall.onclick = () => {
                callDialog.style.display = 'none';
                joinRoom(caller);
            };
            rejectCall.onclick = () => {
                callDialog.style.display = 'none';
            };
        }

        function showPairStatus(status) {
            pairStatusText.textContent = status;
            pairStatus.style.display = 'block';
            setTimeout(() => {
                pairStatus.style.display = 'none';
            }, 3000); // Hide after 3 seconds
        }

        async function createOffer(roomRef, friendId) {
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            const roomWithOffer = {
                offer: {
                    type: offerDescription.type,
                    sdp: offerDescription.sdp
                }
            };
            roomRef.update(roomWithOffer);

            pc.onicecandidate = event => {
                if (event.candidate) {
                    roomRef.child('offerCandidates').push({
                        type: 'candidate',
                        label: event.candidate.sdpMLineIndex,
                        id: event.candidate.sdpMid,
                        candidate: event.candidate.candidate
                    });
                }
            };

            // Send call notification
            db.ref('calls').push({ from: localUserId, to: friendId });
            showPairStatus("Waiting for friend to accept...");
        }

        async function joinRoom(friendId) {
            db.ref('rooms').orderByChild('from').equalTo(friendId).orderByChild('to').equalTo(localUserId).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const room = snapshot.val();
                    for (const [key, value] of Object.entries(room)) {
                        currentRoomId = key;
                        const offerDescription = value.offer;
                        pc.setRemoteDescription(new RTCSessionDescription(offerDescription))
                            .then(() => pc.createAnswer())
                            .then(answerDescription => {
                                pc.setLocalDescription(answerDescription);
                                const roomWithAnswer = {
                                    answer: {
                                        type: answerDescription.type,
                                        sdp: answerDescription.sdp
                                    },
                                    isPaired: true
                                };
                                db.ref('rooms/' + key).update(roomWithAnswer);
                                showPairStatus("You are now paired!");
                                
                                pc.onicecandidate = event => {
                                    if (event.candidate) {
                                        db.ref('rooms/' + key + '/answerCandidates').push({
                                            type: 'candidate',
                                            label: event.candidate.sdpMLineIndex,
                                            id: event.candidate.sdpMid,
                                            candidate: event.candidate.candidate
                                        });
                                    }
                                };

                                db.ref('rooms/' + key + '/offerCandidates').on('child_added', (dataSnapshot) => {
                                    const candidate = dataSnapshot.val();
                                    pc.addIceCandidate(new RTCIceCandidate(candidate));
                                });
                            });
                        break; // We only deal with the first match
                    }
                } else {
                    showPairStatus("Failed to pair up.");
                }
            });
        }

        pc.ontrack = event => {
            remoteStream = event.streams[0];
            remoteVideo.srcObject = remoteStream;
        };
    </script>
</body>
</html>
