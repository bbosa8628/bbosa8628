<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.17.0.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        video {
            width: 300px;
            height: 200px;
            margin: 10px;
            border: 1px solid #ccc;
            background: #000;
        }
        #controls {
            margin-top: 20px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <h1>Random Video Chat</h1>
    <video id="local-video" autoplay muted></video>
    <video id="remote-video" autoplay></video>
    <div id="controls">
        <button id="start-call">Start Call</button>
        <button id="leave-call" disabled>Leave Call</button>
    </div>
    <script>
        const APP_ID = "060dcbbfb2d4446886f5fa8310e6995c"; // Replace with your Agora App ID
const CHANNEL_NAME = "bbosa8628"; // Channel name for random connections
const TEMP_TOKEN = null; // Replace with a token if your project is secured

let client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let localTracks = {};
let remoteTracks = {};

// Start the call
document.getElementById("start-call").onclick = async () => {
    try {
        console.log("Joining channel...");
        const uid = await client.join(APP_ID, CHANNEL_NAME, TEMP_TOKEN, null);
        console.log(`Joined channel as UID: ${uid}`);

        console.log("Creating local tracks...");
        const [audioTrack, videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
        localTracks.audioTrack = audioTrack;
        localTracks.videoTrack = videoTrack;

        // Ensure video is being played
        console.log("Playing local video...");
        const localVideo = document.getElementById("local-video");
        videoTrack.play(localVideo);

        // Check if the video track is available and playing
        if (!videoTrack) {
            console.error("Error: Video track is not available");
        } else {
            console.log("Local video is being played.");
        }

        console.log("Publishing local tracks...");
        await client.publish([audioTrack, videoTrack]);
        console.log("Local tracks published.");

        // Update UI
        document.getElementById("start-call").disabled = true;
        document.getElementById("leave-call").disabled = false;

    } catch (error) {
        console.error("Error joining channel or initializing tracks:", error);
    }
};

// Handle remote user-published event
client.on("user-published", async (user, mediaType) => {
    console.log(`User published: ${user.uid}, mediaType: ${mediaType}`);

    try {
        console.log(`Subscribing to user: ${user.uid}...`);
        await client.subscribe(user, mediaType);
        console.log(`Subscribed to user: ${user.uid}`);

        if (mediaType === "video") {
            // Ensure remote video track is being played
            console.log(`Playing remote video for user: ${user.uid}`);
            const remoteVideo = document.getElementById("remote-video");
            remoteTracks[user.uid] = user.videoTrack;
            user.videoTrack.play(remoteVideo);

            // Check if the remote video track is available
            if (!user.videoTrack) {
                console.error("Error: Remote video track is not available");
            } else {
                console.log("Remote video is being played.");
            }
        }

        if (mediaType === "audio") {
            console.log(`Playing remote audio for user: ${user.uid}`);
            remoteTracks[user.uid] = user.audioTrack;
            user.audioTrack.play();
        }
    } catch (error) {
        console.error("Error subscribing to user:", error);
    }
});

// Handle user-unpublished event
client.on("user-unpublished", (user) => {
    console.log(`User unpublished: ${user.uid}`);
    if (remoteTracks[user.uid]) {
        remoteTracks[user.uid].stop();
        delete remoteTracks[user.uid];
    }
});

// Leave the call
document.getElementById("leave-call").onclick = async () => {
    try {
        console.log("Stopping local tracks...");
        if (localTracks.audioTrack) localTracks.audioTrack.close();
        if (localTracks.videoTrack) localTracks.videoTrack.close();

        console.log("Leaving the channel...");
        await client.leave();
        console.log("Left the channel.");

        // Clear video elements
        document.getElementById("local-video").srcObject = null;
        document.getElementById("remote-video").srcObject = null;

        // Reset UI
        document.getElementById("start-call").disabled = false;
        document.getElementById("leave-call").disabled = true;
    } catch (error) {
        console.error("Error leaving the call:", error);
    }
};

    </script>
</body>
</html>
