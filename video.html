<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat</title>
    <style>
        video { width: 50%; height: auto; }
        #callDialog, #pairStatus { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; }
        .dialogButtons { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Random Video Chat</h1>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="startButton">Start Chat</button>
    <button id="endButton" disabled>End Chat</button>
    <input type="text" id="userId" readonly placeholder="Your ID will appear here" />
    <input type="text" id="callInput" placeholder="Enter friend's ID to call" />
    <button id="callFriend">Call Friend</button>

    <div id="callDialog">
        <p>Incoming call from <span id="callerId"></span></p>
        <div class="dialogButtons">
            <button id="acceptCall">Accept</button>
            <button id="rejectCall">Reject</button>
        </div>
    </div>

    <div id="pairStatus">
        <p id="pairStatusText"></p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase
        var firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          databaseURL: "YOUR_DATABASE_URL",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ],
        };

        const pc = new RTCPeerConnection(servers);

        let localStream;
        let remoteStream;
        let localUserId = null;
        let currentRoomId = null;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startButton = document.getElementById('startButton');
        const endButton = document.getElementById('endButton');
        const callFriend = document.getElementById('callFriend');
        const userIdInput = document.getElementById('userId');
        const callInput = document.getElementById('callInput');
        const callDialog = document.getElementById('callDialog');
        const callerId = document.getElementById('callerId');
        const acceptCall = document.getElementById('acceptCall');
        const rejectCall = document.getElementById('rejectCall');
        const pairStatus = document.getElementById('pairStatus');
        const pairStatusText = document.getElementById('pairStatusText');

        startButton.onclick = async () => {
            startButton.disabled = true;
            endButton.disabled = false;
            
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            localUserId = Math.random().toString(36).substr(2, 10);
            userIdInput.value = localUserId;

            db.collection('calls').where('to', '==', localUserId).onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const call = change.doc.data();
                        showCallDialog(call.from);
                        change.doc.ref.delete();
                    }
                });
            });
        };

        callFriend.onclick = async () => {
            const friendId = callInput.value;
            if (friendId) {
                const roomRef = await db.collection('rooms').add({
                    offerCandidates: [],
                    answerCandidates: [],
                    from: localUserId,
                    to: friendId
                });
                currentRoomId = roomRef.id;
                createOffer(roomRef);
            }
        };

        endButton.onclick = async () => {
            endButton.disabled = true;
            startButton.disabled = false;
            localStream.getTracks().forEach(track => track.stop());
            if (remoteStream) remoteStream.getTracks().forEach(track => track.stop());
            pc.close();
            if (currentRoomId) {
                await db.collection('rooms').doc(currentRoomId).delete();
                currentRoomId = null;
            }
        };

        function showCallDialog(caller) {
            callDialog.style.display = 'block';
            callerId.textContent = caller;
            acceptCall.onclick = () => {
                callDialog.style.display = 'none';
                joinRoom(caller);
            };
            rejectCall.onclick = () => {
                callDialog.style.display = 'none';
            };
        }

        async function createOffer(roomRef) {
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            await roomRef.update({ offer: { type: offerDescription.type, sdp: offerDescription.sdp } });

            pc.onicecandidate = event => {
                if (event.candidate) {
                    roomRef.update({
                        offerCandidates: firebase.firestore.FieldValue.arrayUnion(event.candidate.toJSON())
                    });
                }
            };
        }

        async function joinRoom(callerId) {
            const roomSnapshot = await db.collection('rooms').where('from', '==', callerId).where('to', '==', localUserId).limit(1).get();
            if (!roomSnapshot.empty) {
                const roomRef = roomSnapshot.docs[0];
                const roomData = roomRef.data();

                await pc.setRemoteDescription(new RTCSessionDescription(roomData.offer));
                const answerDescription = await pc.createAnswer();
                await pc.setLocalDescription(answerDescription);

                await roomRef.ref.update({ answer: { type: answerDescription.type, sdp: answerDescription.sdp } });

                pc.onicecandidate = event => {
                    if (event.candidate) {
                        roomRef.ref.update({
                            answerCandidates: firebase.firestore.FieldValue.arrayUnion(event.candidate.toJSON())
                        });
                    }
                };

                roomRef.ref.onSnapshot(async snapshot => {
                    const updatedRoom = snapshot.data();
                    if (updatedRoom && updatedRoom.answerCandidates) {
                        updatedRoom.answerCandidates.forEach(candidate => {
                            pc.addIceCandidate(new RTCIceCandidate(candidate));
                        });
                    }
                });
            }
        }

        pc.ontrack = event => {
            remoteStream = event.streams[0];
            remoteVideo.srcObject = remoteStream;
        };
    </script>
</body>
</html>
