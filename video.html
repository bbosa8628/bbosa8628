<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Video Call with WebRTC</title>
    <style>
        /* Global Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body */
        body {
            font-family: Arial, sans-serif;
            background-color: black;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            text-align: center;
        }

        /* Header */
        h1 {
            color: #ff0000;  /* Red color for the header */
            margin-bottom: 20px;
        }

        /* Main container for videos and buttons */
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            width: 100%;
        }

        /* Video container */
        video {
            width: 45%;  /* Video width, ensuring both videos fit side by side */
            max-width: 480px;  /* Maximum video width */
            height: auto;
            border: 2px solid #b5acac3a;  /* Border around the video */
            margin: 10px;
        }

        /* Buttons */
        button {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            margin: 10px;
        }

        /* Start Call Button (Green) */
        #startCall {
            background-color: #079328;  /* Green color for Start Call */
            color: white;
        }

        /* Stop Call Button (Red) */
        #stopCall {
            background-color: #dc3545;  /* Red color for Stop Call */
            color: white;
            display: none;  /* Initially hide the Stop Call button */
        }

        /* Media Query for mobile responsiveness */
        @media (max-width: 768px) {
            /* Stack videos vertically on smaller screens */
            .container {
                flex-direction: column;
            }

            /* Adjust video size on mobile for better fit */
            video {
                width: 80%;  /* Videos take up more width on mobile */
                max-width: 100%;  /* Ensure videos fit within screen */
                margin: 10px auto;  /* Center videos with margin */
            }

            /* Adjust button sizes for mobile */
            button {
                width: 80%;
                padding: 12px;
            }
        }

    </style>
</head>
<body>
    <h1>bbosa8628 Random Stranger Video Call</h1>
    <div class="container">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
        <br>
        <button id="startCall">Start Call</button>
        <button id="stopCall">Stop Call</button>  <!-- Stop Call button initially hidden -->
    </div>

    <script>
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startCallButton = document.getElementById('startCall');
        const stopCallButton = document.getElementById('stopCall');

        let localStream;
        let peerConnection;
        const ws = new WebSocket('wss://videocall-gyvr.onrender.com');  // Use your Render server URL with 'wss' (WebSocket Secure)
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }; // STUN server config

        async function initLocalStream() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);

            // Add local stream tracks to peer connection
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // Handle remote stream
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
                }
            };
        }

        // Handle WebSocket messages (Signaling)
        ws.onmessage = async (event) => {
            const message = JSON.parse(event.data);

            if (message.type === 'offer') {
                console.log("Received Offer:", message.sdp);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: 'answer', sdp: answer.sdp }));
            } 
            else if (message.type === 'answer') {
                console.log("Received Answer:", message.sdp);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(message));
            } 
            else if (message.type === 'candidate') {
                console.log("Received ICE Candidate:", message.candidate);
                await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
            } 
            else if (message.type === 'end') {
                console.log(message.message);
                // Optionally add UI changes for when the call ends.
                stopCallButton.style.display = 'none';
                startCallButton.style.display = 'block';
            }
        };

        // Start Call: Create an offer and send it
        startCallButton.addEventListener('click', async () => {
            await initLocalStream();
            createPeerConnection();

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            console.log("Sending Offer:", offer.sdp);
            ws.send(JSON.stringify({ type: 'offer', sdp: offer.sdp }));

            // Show stop call button when the call starts
            startCallButton.style.display = 'none';
            stopCallButton.style.display = 'block';
        });

        // Stop Call: Close the connection and send a stop message to the server
        stopCallButton.addEventListener('click', async () => {
            if (peerConnection) {
                // Close the peer connection for this user
                peerConnection.close();
                peerConnection = null;

                // Send a message to the server indicating the user wants to stop the call
                ws.send(JSON.stringify({ type: 'stop', message: 'Stop the call for this user' }));

                // Hide the stop call button after the user clicks it
                stopCallButton.style.display = 'none';
                startCallButton.style.display = 'block';
            }
        });
    </script>
</body>
</html>
