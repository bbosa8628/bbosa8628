<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Random Stranger Video Chat</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, runTransaction, onChildAdded, onDisconnect } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFMg0r23SD663cpLkLd0xteZaWC-D3UxU",
            authDomain: "groupchat-2e3a5.firebaseapp.com",
            databaseURL: "https://groupchat-2e3a5-default-rtdb.firebaseio.com",
            projectId: "groupchat-2e3a5",
            storageBucket: "groupchat-2e3a5.appspot.com",
            messagingSenderId: "991803460047",
            appId: "1:991803460047:web:51d3b785656708842faaba",
            measurementId: "G-F4T57W4HB8"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const usersRef = ref(database, 'users');
        const chatRoomsRef = ref(database, 'chatRooms');

        let username = `Stranger_${Math.floor(Math.random() * 10000)}`;
        const userId = `${username}_${Date.now()}`;
        const userRef = ref(database, `users/${userId}`);

        let chatRoomId = null;

        // WebRTC configuration
        const servers = {
            iceServers: [
                { urls: 'stun:stun.services.mozilla.com' },
                { urls: 'stun:stun.l.google.com:19302' },
                {
                    urls: 'turn:numb.viagenie.ca',
                    credential: 'password',
                    username: 'your-email@example.com'
                }
            ]
        };

        let localStream = null;
        let pc = null;

        set(userRef, { username, paired: false });
        onDisconnect(userRef).remove();

        async function setupWebRTC() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('yourVideo').srcObject = localStream;

            pc = new RTCPeerConnection(servers);
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = event => {
                document.getElementById('friendsVideo').srcObject = event.streams[0];
            };

            pc.onicecandidate = event => {
                if (event.candidate) {
                    sendMessageToChatRoom({ ice: event.candidate });
                }
            };
        }

        function sendMessageToChatRoom(message) {
            if (chatRoomId) {
                push(ref(database, `chatRooms/${chatRoomId}/messages`), {
                    username,
                    message,
                    timestamp: Date.now()
                });
            }
        }

        function handleWebRTCMessage(message) {
            if (message.ice) {
                pc.addIceCandidate(new RTCIceCandidate(message.ice));
            } else if (message.sdp) {
                if (message.sdp.type === 'offer') {
                    pc.setRemoteDescription(new RTCSessionDescription(message.sdp))
                        .then(() => pc.createAnswer())
                        .then(answer => pc.setLocalDescription(answer))
                        .then(() => sendMessageToChatRoom({ sdp: pc.localDescription }));
                } else if (message.sdp.type === 'answer') {
                    pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
                }
            }
        }

        function listenToChatRoom() {
            if (!chatRoomId) return;

            const chatRoomRef = ref(database, `chatRooms/${chatRoomId}/messages`);
            onChildAdded(chatRoomRef, snapshot => {
                const message = snapshot.val().message;

                if (message.username === "System") {
                    showMessage(message.text);
                } else {
                    handleWebRTCMessage(message);
                }
            });
        }

        function showMessage(message) {
            const chatDiv = document.getElementById('chat');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            chatDiv.appendChild(messageElement);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function searchForPartner() {
            showMessage("Searching for a partner...");

            runTransaction(usersRef, users => {
                if (!users) users = {};
                const availableUsers = Object.entries(users).filter(
                    ([key, user]) => !user.paired && key !== userId
                );

                if (availableUsers.length > 0) {
                    const [partnerId, partner] = availableUsers[Math.floor(Math.random() * availableUsers.length)];
                    chatRoomId = `chat_${userId}_${partnerId}`;

                    users[userId] = { username, paired: true, chatRoomId };
                    users[partnerId] = { ...partner, paired: true, chatRoomId };

                    set(ref(database, `chatRooms/${chatRoomId}`), { users: [userId, partnerId] });

                    showMessage(`Connected with ${partner.username}. Starting video chat...`);
                    listenToChatRoom();
                    setupWebRTC().then(() => {
                        pc.createOffer()
                            .then(offer => pc.setLocalDescription(offer))
                            .then(() => sendMessageToChatRoom({ sdp: pc.localDescription }));
                    });
                }

                return users;
            });
        }

        function endChat() {
            if (chatRoomId) {
                sendMessageToChatRoom({ text: `${username} has left the chat.`, system: true });
                if (pc) pc.close();
                location.reload();
            }
        }

        document.getElementById('endButton').addEventListener('click', endChat);

        onValue(userRef, snapshot => {
            const userData = snapshot.val();
            if (userData && userData.chatRoomId) {
                chatRoomId = userData.chatRoomId;
                listenToChatRoom();
            } else {
                searchForPartner();
            }
        });

        function updateActiveUserCount() {
            const activeUserDiv = document.getElementById('activeUsers');

            onValue(usersRef, snapshot => {
                const users = snapshot.val();
                const activeCount = users ? Object.keys(users).length : 0;
                activeUserDiv.textContent = `Active Users: ${activeCount}`;
            });
        }

        updateActiveUserCount();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #1b1b1b;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #activeUsers {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        #videoContainer {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
        }

        video {
            width: 45%;
            margin: 10px;
            border: 2px solid #555;
            background-color: black;
        }

        #chat {
            height: 100px;
            overflow-y: auto;
            padding: 10px;
            border-top: 1px solid #444;
            background-color: #222;
        }

        #messageBox {
            display: flex;
            padding: 10px;
            background-color: #111;
        }

        #messageBox input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #555;
            background-color: #222;
            color: white;
        }

        #messageBox button {
            padding: 10px 20px;
            background-color: #333;
            border: none;
            color: white;
            cursor: pointer;
        }

        #messageBox button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="activeUsers"></div>
    <div id="videoContainer">
        <video id="yourVideo" autoplay muted playsinline></video>
        <video id="friendsVideo" autoplay playsinline></video>
    </div>
    <div id="chat"></div>
    <div id="messageBox">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="endButton">End Chat</button>
    </div>
</body>
</html>
