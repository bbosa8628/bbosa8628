<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat</title>
    <style>
        video { width: 50%; height: auto; }
    </style>
</head>
<body>
    <h1>Random Video Chat</h1>
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <button id="startButton">Start Chat</button>
    <button id="endButton" disabled>End Chat</button>

    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.9/firebase-firestore.js"></script>
    <script>
        // Initialize Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyCFMg0r23SD663cpLkLd0xteZaWC-D3UxU",
            authDomain: "groupchat-2e3a5.firebaseapp.com",
            databaseURL: "https://groupchat-2e3a5-default-rtdb.firebaseio.com",
            projectId: "groupchat-2e3a5",
            storageBucket: "groupchat-2e3a5.appspot.com",
            messagingSenderId: "991803460047",
            appId: "1:991803460047:web:51d3b785656708842faaba",
            measurementId: "G-F4T57W4HB8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ],
        };

        const pc = new RTCPeerConnection(servers);

        let localStream;
        let remoteStream;

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const startButton = document.getElementById('startButton');
        const endButton = document.getElementById('endButton');

        startButton.onclick = async () => {
            startButton.disabled = true;
            endButton.disabled = false;
            
            // Access webcam
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            localVideo.srcObject = localStream;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            // Look for a room or create one
            const roomsRef = db.collection('rooms');
            const availableRoom = await roomsRef.where("hasUser", "==", false).limit(1).get();

            if (availableRoom.empty) {
                // Create a new room if none available
                const roomRef = await roomsRef.add({
                    hasUser: true,
                    offerCandidates: [],
                    answerCandidates: []
                });
                createOffer(roomRef);
            } else {
                // Join the available room
                const room = availableRoom.docs[0];
                room.ref.update({ hasUser: true });
                joinRoom(room);
            }
        };

        endButton.onclick = async () => {
            endButton.disabled = true;
            startButton.disabled = false;
            // Close streams and connection
            localStream.getTracks().forEach(track => track.stop());
            remoteStream.getTracks().forEach(track => track.stop());
            pc.close();
            // Remove room from Firestore
            const roomId = localStorage.getItem('currentRoomId');
            if (roomId) {
                await db.collection('rooms').doc(roomId).delete();
                localStorage.removeItem('currentRoomId');
            }
        };

        async function createOffer(roomRef) {
            localStorage.setItem('currentRoomId', roomRef.id);
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            const roomWithOffer = {
                offer: {
                    type: offerDescription.type,
                    sdp: offerDescription.sdp
                }
            };
            await roomRef.update(roomWithOffer);

            pc.onicecandidate = event => {
                if (event.candidate) {
                    roomRef.update({
                        offerCandidates: firebase.firestore.FieldValue.arrayUnion({
                            type: 'candidate',
                            label: event.candidate.sdpMLineIndex,
                            id: event.candidate.sdpMid,
                            candidate: event.candidate.candidate
                        })
                    });
                }
            };
        }

        async function joinRoom(room) {
            localStorage.setItem('currentRoomId', room.id);
            const offerDescription = room.data().offer;
            await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);

            const roomWithAnswer = {
                answer: {
                    type: answerDescription.type,
                    sdp: answerDescription.sdp
                }
            };
            await room.update(roomWithAnswer);

            pc.onicecandidate = event => {
                if (event.candidate) {
                    room.update({
                        answerCandidates: firebase.firestore.FieldValue.arrayUnion({
                            type: 'candidate',
                            label: event.candidate.sdpMLineIndex,
                            id: event.candidate.sdpMid,
                            candidate: event.candidate.candidate
                        })
                    });
                }
            };

            // Listen for remote ICE candidates
            room.ref.collection('offerCandidates').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        let data = change.doc.data();
                        pc.addIceCandidate(new RTCIceCandidate(data));
                    }
                });
            });
        }

        pc.ontrack = event => {
            remoteStream = event.streams[0];
            remoteVideo.srcObject = remoteStream;
        };

    </script>
</body>
</html>